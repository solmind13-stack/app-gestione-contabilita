rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== HELPER FUNCTIONS ==========
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getUserRole() {
      return getUserProfile().role;
    }
    
    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }
    
    function hasGlobalWriteAccess() {
        let userRole = getUserRole();
        return isSignedIn() && (userRole == 'admin' || userRole == 'editor');
    }

    // ========== COLLECTION: users ==========
    // Allows admin to manage users, and users to manage their own data.
    match /users/{userId} {
      // Create: Any signed-in user can create their own profile. Admin can create any profile.
      allow create: if isSignedIn() && (isOwner(userId) || isAdmin());
      // Get: Users can get their own profile. Admin can get any profile.
      allow get: if isSignedIn() && (isOwner(userId) || isAdmin());
      // List: Only admins can list all users.
      allow list: if isAdmin();
      // Update: Only admins can update user profiles (e.g., change roles).
      allow update: if isAdmin();
      // Delete: Admin can delete any user except themselves.
      allow delete: if isAdmin() && request.auth.uid != userId;

      // Subcollections: Users can manage their own subcollections (like chat history).
      match /{allChildren=**} {
          allow read, write: if isSignedIn() && isOwner(userId);
      }
    }

    // ========== FINANCIAL DATA COLLECTIONS ==========
    // This rule applies to movements, deadlines, incomeForecasts, and expenseForecasts.
    match /{collection}/{docId} where collection in ['movements', 'deadlines', 'incomeForecasts', 'expenseForecasts'] {
      
      // Determines if a user can READ data for a specific company.
      function canReadCompanyData() {
        if (!isSignedIn()) { return false; }
        let userRole = getUserRole();
        let userCompany = getUserProfile().company; // The company assigned to the user ('LNC' or 'STG')
        let docCompany = resource.data.societa; // The company specified in the document being read
        
        // Allow access if:
        // - User is 'admin' or 'editor' (can see everything).
        // - User has a company-specific role ('company' or 'company-editor') AND their assigned company matches the document's company.
        return userRole == 'admin' || userRole == 'editor' || 
               ((userRole == 'company' || userRole == 'company-editor') && userCompany == docCompany);
      }
      
      // Determines if a user can WRITE data for a specific company.
      function canWriteCompanyData() {
        if (!isSignedIn()) { return false; }
        let userRole = getUserRole();
        let userCompany = getUserProfile().company;
        // For writes (create, update), we check the incoming data in `request.resource`.
        let docCompany = request.resource.data.societa;

        // Allow write access if:
        // - User is 'admin' or 'editor' (global write access).
        // - User is a 'company-editor' AND their assigned company matches the document's company.
        return userRole == 'admin' || userRole == 'editor' || 
               (userRole == 'company-editor' && userCompany == docCompany);
      }

      // Determines if the current user is the one who created the document.
      function isDocumentCreator() {
        // `resource.data` is used here because this is for an existing document.
        return request.auth.uid == resource.data.createdBy;
      }
      
      // ========== PERMISSIONS ==========

      // GET: Allow if the user has read permission for the document's company.
      allow get: if canReadCompanyData();
      
      // CREATE, UPDATE: Allow if the user has write permission.
      // This covers both creating new documents and modifying existing ones.
      allow create, update: if canWriteCompanyData();
      
      // DELETE: Stricter. Only admin or the original creator of the document can delete.
      allow delete: if isAdmin() || isDocumentCreator();
      
      // LIST: This is the most complex rule. It prevents users from listing documents they shouldn't see.
      allow list: if isSignedIn() && 
                  (
                    // Admins and editors can list everything.
                    hasGlobalWriteAccess() ||
                    // Company-specific users can only list data if they explicitly filter by their own company.
                    // This is CRITICAL. It forces the client-side query to include `where('societa', '==', user.company)`.
                    (
                      (getUserRole() == 'company' || getUserRole() == 'company-editor') &&
                      request.query.where[0][0] == 'societa' && 
                      request.query.where[0][1] == '==' && 
                      request.query.where[0][2] == getUserProfile().company
                    )
                  );
    }
  }
}
