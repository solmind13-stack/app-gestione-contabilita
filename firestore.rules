rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== HELPER FUNCTIONS ==========
    
    // Funzione per verificare se l'utente è autenticato.
    function isSignedIn() {
      return request.auth != null;
    }

    // Funzione per verificare se l'utente è il proprietario del documento richiesto.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Funzione per ottenere i dati del profilo dell'utente che effettua la richiesta.
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Funzione per ottenere il ruolo dell'utente.
    function getUserRole() {
      return getUserProfile().role;
    }

    // ========== COLLECTION: users ==========
    match /users/{userId} {
      
      // CREATE: Qualsiasi utente autenticato può creare il proprio profilo.
      // Un admin può creare il profilo di chiunque.
      allow create: if isSignedIn() && (isOwner(userId) || getUserRole() == 'admin');

      // READ (get): Un utente può leggere il proprio profilo. Un admin può leggere qualsiasi profilo.
      allow get: if isSignedIn() && (isOwner(userId) || getUserRole() == 'admin');
      
      // READ (list): Solo un admin può elencare tutti gli utenti.
      allow list: if isSignedIn() && getUserRole() == 'admin';
      
      // UPDATE: Un utente può modificare il proprio profilo. Un admin può modificare qualsiasi profilo.
      // Un utente non può cambiare il proprio ruolo, a meno che non sia un admin.
      allow update: if isSignedIn() && 
                    (
                      (getUserRole() == 'admin') || 
                      (isOwner(userId) && request.resource.data.role == resource.data.role)
                    );
      
      // DELETE: Solo gli admin possono eliminare gli utenti. Non possono eliminare se stessi.
      allow delete: if isSignedIn() && getUserRole() == 'admin' && request.auth.uid != userId;

      // === Sub-collections (es. chatHistory) ===
      match /{allChildren=**} {
          // Solo il proprietario del profilo può leggere e scrivere nelle sotto-collezioni.
          allow read, write: if isSignedIn() && isOwner(userId);
      }
    }

    // ========== FINANCIAL DATA COLLECTIONS ==========
    match /{collection}/{docId} where collection in ['movements', 'deadlines', 'incomeForecasts', 'expenseForecasts'] {
      
      // Funzione per verificare se l'utente può accedere ai dati di una specifica società.
      function canAccessCompanyData(company) {
        if (!isSignedIn()) { return false; }
        let userRole = getUserRole();
        // L'accesso è consentito se l'utente è admin, editor, o se ha il ruolo 'company'
        // e sta cercando di accedere ai dati della sua società.
        return userRole == 'admin' || userRole == 'editor' || 
               (userRole == 'company' && getUserProfile().company == company);
      }

      // READ (get), UPDATE, DELETE: Permesso se l'utente ha accesso ai dati della società del documento.
      allow get, update, delete: if canAccessCompanyData(resource.data.societa);
      
      // CREATE: Permesso se l'utente ha accesso ai dati della società del nuovo documento.
      allow create: if canAccessCompanyData(request.resource.data.societa);

      // LIST (query): Questa è la regola cruciale per il ruolo 'company'.
      // Un admin o un editor possono fare query liberamente (l'app poi filtra client-side).
      // Un utente con ruolo 'company' DEVE OBBLIGATORIAMENTE includere un filtro 'where'
      // sulla propria società. Questo impedisce loro di vedere i dati di altre società.
      allow list: if isSignedIn() && 
                  (
                    getUserRole() == 'admin' || 
                    getUserRole() == 'editor' ||
                    (
                      getUserRole() == 'company' &&
                      request.query.where[0][0] == 'societa' && 
                      request.query.where[0][1] == '==' && 
                      request.query.where[0][2] == getUserProfile().company
                    )
                  );
    }
  }
}
