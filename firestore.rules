rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData() {
      // Allow reading own user data for role checks.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isUserRole(role) {
      // Ensure the user is signed in and their document exists before checking the role.
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getUserData().role == role;
    }
    
    function canAccessCompanyData(company) {
      if (!isSignedIn() || !exists(/databases/$(database)/documents/users/$(request.auth.uid))) {
        return false;
      }
      let userData = getUserData();
      return userData.role == 'admin' || userData.role == 'editor' || (userData.role == 'company' && userData.company == company);
    }
    
    // Rules for the 'users' collection
    match /users/{userId} {
      // CREATE: Any signed-in user can create THEIR OWN user document. This is critical for the signup flow.
      allow create: if isOwner(userId);

      // READ (get): A user can read THEIR OWN document. This unblocks the login flow.
      // An admin can also read any document.
      allow get: if isOwner(userId) || isUserRole('admin');
      
      // LIST: Only users with the 'admin' role can list all user documents.
      allow list: if isUserRole('admin');
      
      // UPDATE: A user can update their own profile. An admin can update any profile.
      // A user cannot change their own role unless they are an admin.
      allow update: if isUserRole('admin') || (isOwner(userId) && request.resource.data.role == resource.data.role);
      
      // DELETE: Only admins can delete users.
      allow delete: if isUserRole('admin');
    }

    // Rules for financial data collections (movements, deadlines, forecasts)
    match /{collection}/{docId} where collection in ['movements', 'deadlines', 'incomeForecasts', 'expenseForecasts'] {
      // READ (get) & WRITE (update, delete) on existing documents.
      // Access is granted if the user has the right role for the company specified IN THE DOCUMENT ITSELF.
      allow get, update, delete: if canAccessCompanyData(resource.data.societa);
      
      // CREATE a new document.
      // Access is granted if the user has the right role for the company specified IN THE INCOMING DOCUMENT.
      allow create: if canAccessCompanyData(request.resource.data.societa);

      // LIST (query multiple documents)
      // Admins and Editors can list all documents without restriction.
      // Company users MUST include a 'where("societa", "==", theirCompany)' clause in their queries.
      allow list: if (isUserRole('admin') || isUserRole('editor')) || 
                     (isUserRole('company') && request.query.where.size() > 0 && request.query.where[0].fieldPath == 'societa' && request.query.where[0].op == '==' && request.query.where[0].value == getUserData().company);
    }
    
    // Sub-collections for users, like chatHistory
    match /users/{userId}/{allChildren=**} {
        allow read, write: if isOwner(userId);
    }
  }
}
