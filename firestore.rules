rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isUserRole(role) {
        return isSignedIn() && getUserData().role == role;
    }
    
    function canAccessCompanyData(company) {
      let userRole = getUserData().role;
      return isSignedIn() && (userRole == 'admin' || userRole == 'editor' || (userRole == 'company' && getUserData().company == company));
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Admins can read any user profile
      // Any authenticated user can read their own profile
      allow get: if isUserRole('admin') || isOwner(userId);
      
      // Only admins can list all users
      allow list: if isUserRole('admin');
      
      // An authenticated user can create their own profile
      allow create: if isOwner(userId);
      
      // An admin can update any user profile
      // An authenticated user can update their own profile, but cannot change their role
      allow update: if isUserRole('admin') || (isOwner(userId) && request.resource.data.role == resource.data.role);
      
      // Only admins can delete users
      allow delete: if isUserRole('admin');
      
      // Sub-collections for users, like chatHistory
      match /{allChildren=**} {
        allow read, write: if isOwner(userId);
      }
    }

    // Rules for financial data collections
    match /{collection}/{docId} {
      // Generic rule for financial documents (movements, deadlines, etc.)
      
      // READ:
      // An admin or editor can read any document.
      // A company user can read a document if its 'societa' field matches their company.
      allow get: if canAccessCompanyData(resource.data.company);
      
      // LIST (Query):
      // This is the most critical rule. Listing is only allowed if the query
      // is constrained by 'societa'. This forces the client to ask for specific
      // company data, preventing the "Missing or insufficient permissions" error.
      // Admins and editors are allowed to query without this constraint.
      allow list: if (isUserRole('admin') || isUserRole('editor')) || 
                     (isUserRole('company') && request.query.get('where')[0][1] == 'societa' && request.query.get('where')[0][2] == getUserData().company);

      // WRITE (Create, Update, Delete):
      // An admin or editor can write to any document.
      // A company user can write to a document if its 'societa' field matches their company.
      allow write: if canAccessCompanyData(request.resource.data.company);
    }
    
    // Fallback security for any other collections
    match /{path=**}/documents/{document} {
      allow read, write: if false;
    }
  }
}
