rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Rules for the 'users' collection
    match /users/{userId} {
      // CREATE: Any authenticated user can create THEIR OWN user document.
      // An anonymous user can create a document for another user (for bootstrapping).
      allow create: if isSignedIn() && (isOwner(userId) || request.auth.token.firebase.sign_in_provider == 'anonymous');

      // READ (get): A user can read THEIR OWN document.
      allow get: if isSignedIn() && isOwner(userId);
      
      // LIST: An admin can list all users. This is for the User Management UI.
      allow list: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // UPDATE: A user can update their own profile. An admin can update any profile.
      // A user is not allowed to change their own role.
      allow update: if isSignedIn() && (
                    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') || 
                    (isOwner(userId) && request.resource.data.role == resource.data.role)
                  );
      
      // DELETE: Only admins can delete users.
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Rules for financial data collections (movements, deadlines, forecasts)
    match /{collection}/{docId} where collection in ['movements', 'deadlines', 'incomeForecasts', 'expenseForecasts'] {
      
      function getUserRole() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      }
      
      function getUserCompany() {
         return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company;
      }

      function canAccessCompanyData(company) {
        if (!isSignedIn()) { return false; }
        let userRole = getUserRole();
        return userRole == 'admin' || userRole == 'editor' || 
               (userRole == 'company' && getUserCompany() == company);
      }

      // READ (get), UPDATE, DELETE on existing documents.
      allow get, update, delete: if isSignedIn() && canAccessCompanyData(resource.data.societa);
      
      // CREATE a new document.
      allow create: if isSignedIn() && canAccessCompanyData(request.resource.data.societa);

      // LIST (query multiple documents)
      // Admins and editors can query freely.
      // Company users MUST filter by their own company.
      allow list: if isSignedIn() && (
                    getUserRole() == 'admin' || 
                    getUserRole() == 'editor' ||
                    (getUserRole() == 'company' && request.query.where[0].field == 'societa' && request.query.where[0].op == '==' && request.query.where[0].value == getUserCompany())
                  );
    }
    
    // Sub-collections for users, like chatHistory
    match /users/{userId}/{allChildren=**} {
        // Only the owner of the user profile can read or write to its sub-collections.
        allow read, write: if isOwner(userId);
    }
  }
}
